<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Working with four dimensional images, with some revision &mdash; RCSDS 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="RCSDS 0.1 documentation" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="working-with-four-dimensional-images-with-some-revision">
<h1>Working with four dimensional images, with some revision<a class="headerlink" href="#working-with-four-dimensional-images-with-some-revision" title="Permalink to this headline">¶</a></h1>
<div class="section" id="loading-data-with-nibabel">
<h2>Loading data with nibabel<a class="headerlink" href="#loading-data-with-nibabel" title="Permalink to this headline">¶</a></h2>
<p>First let&#8217;s load a three-dimensional file, like the one we were looking at last week.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nib</span>
</pre></div>
</div>
<p>First we <code class="docutils literal"><span class="pre">load</span></code> the image, to give an &#8220;image&#8221; object:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;ds107_sub001_highres.nii&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can explore the returned image object with <code class="docutils literal"><span class="pre">img.</span></code> followed by TAB in the
IPython console.</p>
<p>Because images can have large arrays, nibabel does not load the image
array when you <code class="docutils literal"><span class="pre">load</span></code> the image, in order to save time and memory. The
best way to get the image array data is with the <code class="docutils literal"><span class="pre">get_data()</span></code> method.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
<span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>This gives:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">memmap</span><span class="o">.</span><span class="n">memmap</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">memmap</span></code> is a special type of array that saves memory, but
otherwise behaves the same as any normal array.</p>
<p>The data is a three dimensional array.  We can show slices from this data with matplotlib.</p>
</div>
<div class="section" id="four-dimensional-arrays-space-time">
<h2>Four dimensional arrays - space + time<a class="headerlink" href="#four-dimensional-arrays-space-time" title="Permalink to this headline">¶</a></h2>
<p>Images can also be four-dimensional.  It&#8217;s easiest to think of four
dimensional images as a stack of 3-dimensional images (volumes).</p>
<p>Here we load a four dimensional image.  It is an functional MRI image, where
the volumes are collected in sequence a few seconds apart.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;ds114_sub009_t2r1.nii&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</pre></div>
</div>
<p>The image we have just loaded is a four-dimensional image, with
a four-dimensional array:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">173</span><span class="p">)</span>
</pre></div>
</div>
<p>The first three axes represent three dimensional space. The last axis
represents time. Here the last (time) axis has length 173. This means that,
for each of these 173 elements, there is one whole three dimensional image. We
often call the three-dimensional images <em>volumes</em>. So we could say that this
4D image contains 173 volumes.</p>
<p>We have previously been taking slices over the third axis of
a three-dimensional image. We can now take slices over the fourth axis of this
four-dimensional image:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">first_vol</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c"># A slice over the final (time) axis</span>
</pre></div>
</div>
<p>This slice selects the first three-dimensional volume (3D image) from
the 4D array:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">first_vol</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
<p>You can use the ellipsis <code class="docutils literal"><span class="pre">...</span></code> when slicing an array. The ellipsis is
a short cut for &#8220;everything on the previous axes&#8221;. For example, these
two have exactly the same meaning:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">first_vol</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">first_vol_again</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c"># Using the ellipsis</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">first_vol</span></code> is a 3D image just like the 3D images you have already seen:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># A slice over the third dimension of a 3D image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">first_vol</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">14</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/first_vol_slice.png" src="../_images/first_vol_slice.png" />
</div>
<div class="section" id="numpy-operations-work-on-the-whole-array-by-default">
<h2>Numpy operations work on the whole array by default<a class="headerlink" href="#numpy-operations-work-on-the-whole-array-by-default" title="Permalink to this headline">¶</a></h2>
<p>Numpy operations like <code class="docutils literal"><span class="pre">min</span></code>, and <code class="docutils literal"><span class="pre">max</span></code> and <code class="docutils literal"><span class="pre">std</span></code> operate on the whole
numpy array by default, ignoring any array shape. For example, here is the
maximum value for the whole 4D array:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">6793</span>
</pre></div>
</div>
<p>This is exactly the same as:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># maximum when flattening the array to 1 dimension</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
</pre></div>
</div>
<p>You can ask numpy to operate over particular axes instead of operating over
the whole array. For example, this will generate a 3D image, where each array
value is the variance over the 173 values at that 3D position (the variance
across time):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># variance across the final (time) axis</span>
<span class="n">var_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">var_vol</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">14</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/variance_slice.png" src="../_images/variance_slice.png" />
</div>
<div class="section" id="indexing-with-boolean-arrays">
<h2>Indexing with boolean arrays<a class="headerlink" href="#indexing-with-boolean-arrays" title="Permalink to this headline">¶</a></h2>
<p>We covered this briefly a few classes back.</p>
<p>Let&#8217;s say we have an array like this:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
</pre></div>
</div>
<p>We can get a True / False (boolean) array to tell us whether these
values are above some threshold:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tf_array</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">&gt;</span> <span class="mi">2</span>
<span class="n">tf_array</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">array</span><span class="p">([[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span>
       <span class="p">[</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</pre></div>
</div>
<p>You can flip the True / False values with <code class="docutils literal"><span class="pre">~</span></code> (bitwise not):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="o">~</span><span class="n">tf_array</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="n">array</span><span class="p">([[</span> <span class="bp">True</span><span class="p">,</span>  <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">],</span>
       <span class="p">[</span><span class="bp">False</span><span class="p">,</span>  <span class="bp">True</span><span class="p">,</span>  <span class="bp">True</span><span class="p">,</span>  <span class="bp">True</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
</pre></div>
</div>
<p>We can use boolean arrays to <em>index</em> into the original array (or any array
with a suitable shape). This will select only the elements where the boolean
array is <code class="docutils literal"><span class="pre">True</span></code>. The returned array may well have selected only a few
members from any particular row or column or (in general) higher axis, so the
returned array is always one-dimensional to reflect the loss of shape:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">selected_elements</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">tf_array</span><span class="p">]</span>
<span class="n">selected_elements</span>
</pre></div>
</div>
<p>This gives:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<p>The returned array is shape <code class="docutils literal"><span class="pre">(2,)</span></code> (one-dimensional).</p>
<p>We can use this to select values in our image as well. For example, if we
wanted to select only values less than 10 in <code class="docutils literal"><span class="pre">first_vol</span></code>:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">tf_lt_10</span> <span class="o">=</span> <span class="n">first_vol</span> <span class="o">&lt;</span> <span class="mi">10</span>
<span class="n">vals_lt_10</span> <span class="o">=</span> <span class="n">first_vol</span><span class="p">[</span><span class="n">tf_lt_10</span><span class="p">]</span>
<span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">vals_lt_10</span><span class="p">)</span>
</pre></div>
</div>
<p>This gives:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int16</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">RCSDS</a></h1>



<p class="blurb">Fall 2015</p>




<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../standard/index.html">Core Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Lectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/index.html">Labs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../append/index.html">Appendices</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="http://www.jarrodmillman.com/stat159-fall2015/">Course home</a></li>
    
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="footer">
      &copy;2015, K. Jarrod Millman.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
        <p><small>  <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise.
</small></p>
    </div>

  </body>
</html>